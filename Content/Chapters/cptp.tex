\chapter{The Capacitated Profitable Tour Problem (CPTP)}

\cite{Jepsen2014} provided in their work an IP formulation for the CPTP.
The IP model presented in this section is derived from their work, and it is here summarized.

Let $G = \Tuple*{V, E}$ denote a complete undirected graph, where $V = \Set*{0, 1, \dots, N - 1}$ denotes the set of nodes,
$E = \Set*{e = (i, j) \mid i,j \in V, j \ge i + 1}$ the set of edges, and $N$ the number of nodes in the graph.
The value $0 \in V$ is used to denote the depot node.
For convenience, we define $V_0 = V \setminus \Set*{0}$ to express the set of customers, and $N_0 = N - 1$ to denote the number of customers.
Let $\delta(S)$ with $S \subseteq V$ denote the edges crossing the set $S$ and its complement $\overline{S} = V \setminus S$.
More formally we can express $\delta(S)$ as $\delta(S) = \Set*{ (i, j) \in E \mid i \in \Expr*{S \cap V}, j \in \Expr*{ \overline{S} \cap V } }$.
For brevity, we also define $\delta(i) = \delta(\Set*{i})$ to denote the set of edges incident to node $i \in V$.

Let $p_{i} \in \R, p_{i} \ge 0$ denote the profit function, and $q_{i} \in \R, q_{i} \ge 0$ denote the demand function, which represent respectively the profit gain and required demand in visiting a vertex $i \in V$.
By convention $q_0 = 0$, but notice that the profit at the depot is allowed to be $p_0 \ge 0$.
Let $d_{ij} \in \R, d_{ij} > 0$ denote the distance function between a pair of nodes  $i, j \in V$.
We assume that the distance function is symmetric $d_{ij} = d_{ji}$ and satisfies the triangle inequality $d_{ij} \le d_{ih} + d_{hj}$.

We define two sets of binary variables: $x_{ij}$, $y_{i} \in \Set*{0, 1}$, used to compose output solutions for the CPTP.
Together they model respectively an edge and a vertex as being part of the tour solution.

Given an upper bound $Q \in \R,Q \ge 0$ for the total resource consumption, we can finally express the CPTP problem as an integer programming formulation


\begin{align}
	\min_{x,y} \quad z(x, y) & =  \sum_{i \in V} \sum_{\EqStackTwo{j \in V}{j \ge i + 1}} d_{ij} x_{ij} - \sum_{i \in V} p_i y_i \label{eq:obj-function}                                                                                                                \\
	                         & y_0 = 1                                                                                                                   & \label{eq:depot-part-of-tour-constraint}                                                                     \\
	                         & \ExprCptpEdgesIncident{i}  = 2 y_i                                                                                        & \quad \forall i \in V         \label{eq:flow-conservation-constraint}                                        \\
	                         & \ExprCptpFlowExiting{S} \ge 2 y_{i}                                                                                       & \quad \EqStackTwo{\forall i \in S}{\forall S \subseteq V_0,\ \SetSize*{S} \ge 2} \label{eq:gsec-constraints} \\
	                         & \ExprCptpDemandSum  \le Q                                                                                                 & \label{eq:resource-upper-bound-constraint}                                                                   \\
	                         & x_{ij}                   \in \Set*{0, 1}                                                                                  & \quad \forall (i, j) \in E               \label{eq:x-mip-var-bounds}                                         \\
	                         & y_{i}                    \in \Set*{0, 1}                                                                                  & \quad \forall i \in V,\ i \ge 1          \label{eq:y-mip-var-bounds}
\end{align}

The equation \eqref{eq:obj-function} denotes the objective function, and it is made of two terms: the cost of traveling through the tour (positive contribution) and the total sum of the profits associated to visiting a subset of the vertices (negative contribution).
The constraint \eqref{eq:depot-part-of-tour-constraint} ensures that the depot is always visited.
Constraints \eqref{eq:flow-conservation-constraint} imposes flow conservation constraints for each vertex.
The equation \eqref{eq:gsec-constraints} are the generalized subtour elimination constraints \textbf{(GSECs)} and must be present to guarantee that the solution does not contain spurious unconnected subtours.
There is an exponential number of GSECs, as such, for performance reasons these constraints cannot be inserted statically in a MIP solver, and must instead be efficiently dynamically separated.
The equation \eqref{eq:resource-upper-bound-constraint} models the fact that a tour may visit any vertex as long as the total demand doesn't exceed the vehicle capacity.
Finally, the equations \eqref{eq:x-mip-var-bounds}, \eqref{eq:y-mip-var-bounds} specify the bounds and domain of the $x_{ij}$ and $y_{i}$ variables respectively.

The IP model consists of $\frac{N^2 + N}{2}$ number of binary variables.
If we ignore the GSECs and the binary variable bounds, the total number of constraints characterizing the model add up to $N + 2$.

Note that the IP formulation only permits solutions visiting at least three vertices (the depot and two customers).
We could allow for single customer solutions by relaxing the binary variable requirements and by modifying the IP model.
Instead, it may be simpler to take a different approach and leave the IP model as is.
By employing a bruteforce algorithm in $\Theta(N)$ time we can scan for improving single-customer solutions.
After the resolution of the IP model, we check for improving single-customer solutions and, if any exist, we update the incumbent.

\subsection{GSECs inequalities}\label{sec:gsec-inequality}

\mytodo{Add more details/history/literature about GSECs here.}


It may be interesting to study the relationship between the number of non-zero binary variables participating in a GSEC as a function of the set size $\SetSize*{S}$.
To achieve this we can express the size of the edge crossing set $\delta(S)$ as

\begin{equation}\label{eq:delta-s-set-size}
	\SetSize*{\delta(S)} = \SetSize*{S} (N - \SetSize*{S})
\end{equation}

which is maximized when $\SetSize*{S} = \frac{N}{2}$, thus leading to the following easy upper bound:

\begin{equation}\label{eq:delta-s-set-size-ub}
	\SetSize*{\delta(S)} \le \frac{N^2}{4}
\end{equation}

Let $\NNZGSEC(S)$ denote the number of non-zero binary variables participating in a GSEC inequality.
It is easy to see that the following result holds
\begin{equation}\label{eq:gsec-nnz-ub}
	\NNZGSEC(S) \le 1 + \floor*{\frac{N^2}{4}} \quad \forall S \subseteq V_0,\ \SetSize*{S} \ge 2
\end{equation}
This trivial bound allows us to preallocate a fixed amount of memory beforehand prior to performing any inequality separation, saving us copious memory allocation time.

\subsection{Additional bounds}

\subsubsection{Demand lower bound}\label{sec:demand-lower-bound}
Although non strictly-necessary, it is possible to improve the linear relaxation of the IP model by introducing a static constraint modeling a lower bound on the minimum served demand:

\begin{equation}\label{eq:resource-lower-bound-constraint}
	\ExprCptpDemandSum[i]   \ge B
\end{equation}

where $B \in \R, B \ge 0$ is a constant and represents the the required minimum served demand.
The constant $B$ value can be computed as $B = q_u + q_v$, where $u, v \in V_0, u \ne v$ represent the least two demanding customers among all the customers, i.e. $q_u \le q_v \le q_i \quad \forall i \in V_0,\ i \ne u, v$.

\section{A simple dual formulation}\label{sec:cptp-simple-dual-formulation}

A simple dual formulation for the ESPPRC is presented in \cite{beasley1989algorithm} and it is here presented and re-adapted for the CPTP problem.

We first need to re-formulate the CPTP as an ESPPRC over a directed network.
We define a new drected network formulation $G_d = \Tuple*{V_d, E_d}$ composed of $N + 1$ nodes, where the depot node is essentially split in two nodes: a source and a sink vertex.
In the new network we use the value $0$ to denote the source version of the depot node, and $N$ its duplicate playing the role of the sink vertex.
More formally, $V_d = \Set*{ 0,\dots, N }$, and the edge set $E_d$ is

\begin{equation}
	\begin{aligned}
		E_d = & \Set*{\Tuple*{i, j} \quad \forall i, j \in V_d,\ i \ne j } \\
		      & \setminus \Set*{ \Tuple*{0, N} }                           \\
		      & \setminus \Set*{ \Tuple*{i, 0} \quad \forall i \in V_d }   \\
		      & \setminus \Set*{ \Tuple*{N, i} \quad \forall i \in V_d }   \\
	\end{aligned}
\end{equation}

which briefly means: all possible pairs $\Tuple*{i, j},\ i \ne j$ excluding: direct connection between $0$ and $N$, and by exluding edges entering node $0$ and flowing out of node $N$.
At each directed edge $\Tuple*{i, j} \in E_d$ we associate a cost $c_{ij} \in \R$.
We define a new set of binary variables $e_{ij} \in \Set*{0, 1} \quad \forall \Tuple*{i, j} \in E_d$, to model solutions for ESPPRC over the directed network.

Is is easy to see that $2 y_i$ in the original CPTP formulation can now be rewritten in the ESPPRC formulation as:

\begin{equation}
	2 y_i = \ExprESPPIngoingEdges{i} + \ExprESPPOutgoingEdges{i} \quad \forall i \in V_0
\end{equation}

Since we are creating a new node, we are also duplicating some edges and we must pay attention that these edges bind to the same CPTP original formulation.
We can bind the new edges to the original CPTP formulation by employing a mutually exclusive constraint of the form:

\begin{equation}
	e_{0i} + e_{iN} \le 1 \quad \forall i \in V_0
\end{equation}

Finally, by setting $c_{ij} = \ExprCptpReducedCost{i}{j} \quad \forall \Tuple*{i, j} \in E_d$, we can rewrite the CPTP original formulation in the ESPPRC IP model:

\begin{align}
	\min_{e} \quad z_\mt{ESPPRC}(e) & =  \sum_{(i, j) \in E_d} \Expr*{ \ExprCptpReducedCost{i}{j} } e_{ij} \label{eq:espprc-obj-function}                                                                                            \\
	                                & B \le \sum_{i \in V_0} \frac{q_i}{2} \Expr*{ \ExprESPPIngoingEdges{i} + \ExprESPPOutgoingEdges{i} }  \le Q                            \label{eq:espprc-resource-upper-bound-constraint}        \\
	                                & \ExprESPPIngoingEdges{i} = \ExprESPPOutgoingEdges{i}                                                \qquad \forall i \in V_0          \label{eq:espprc-flow-conservation-constraint-customers} \\
	                                & \ExprESPPOutgoingEdges[i]{0} = 1                                                                                                      \label{eq:espprc-flow-conservation-constraint-depot1}    \\
	                                & \ExprESPPIngoingEdges[i]{N} = 1                                                                                                       \label{eq:espprc-flow-conservation-constraint-depot2}    \\
	                                & \ExprESPPEdgesWithin[S] \le |S| - 1                                                                  \qquad \forall S \subseteq V_d   \label{eq:espprc-sec-constraints}                        \\
	                                & e_{0i} + e_{iN} \le 1                                                                                \qquad \forall i \in V_0         \label{eq:espprc-cptp-binding}                           \\
	                                & e_{ij}                   \in \lbrace 0, 1 \rbrace                                                    \qquad \forall \Tuple*{i, j} \in E_d    \label{eq:espprc-e-mip-var-bounds}                \\
\end{align}

where, \eqref{eq:espprc-obj-function} is the new objective function where we dropped the dependency on the $y$ MIP variable,
\eqref{eq:espprc-resource-upper-bound-constraint} is the resource bound expressed as a function of only the $e$ MIP variable,
\eqref{eq:espprc-flow-conservation-constraint-customers} is the flow conservation for all vertices except the source and sink node
and \eqref{eq:espprc-flow-conservation-constraint-depot1}, \eqref{eq:espprc-flow-conservation-constraint-depot2} are the flow conservation for respectively the source and sink node,
\eqref{eq:espprc-cptp-binding} avoids forming paths where a single customer is visited,
and finally \eqref{eq:espprc-sec-constraints} are the new subtour elimination constraints which avoid the forming of spurious subtours in unconnected regions of nodes.

\cite{beasley1989algorithm} propose to ignore the SEC in \eqref{eq:espprc-sec-constraints} and relaxing \eqref{eq:espprc-resource-upper-bound-constraint}, \eqref{eq:espprc-cptp-binding} in a Lagrangean fashion:

\begin{align}
	\min_{e} \quad z_\mt{ESPP}(e) & = \lambda_0 B - \lambda_1 Q + \sum_{(i, j) \in E_d}  c'_{ij} e_{ij} - \sum_{i \in V_0} \beta_i  \label{eq:esp-relaxed-obj-function} \\
	                              & \ExprESPPIngoingEdges{i} = \ExprESPPOutgoingEdges{i}        \qquad \forall i \in V_0                                                \\
	                              & \ExprESPPOutgoingEdges[i]{0} = 1                                                                                                    \\
	                              & \ExprESPPIngoingEdges[i]{N} = 1                                                                                                     \\
	                              & e_{ij}                   \in \lbrace 0, 1 \rbrace           \qquad \forall \Tuple*{i, j} \in E_d
\end{align}

where:

\begin{equation}
	c'_{ij} =
	\begin{cases}
		\Expr*{\ExprCptpReducedCost{i}{j}} + \Expr*{\lambda_1 - \lambda_0} \frac{q_i + q_j}{2},           & \texttt{if } i \in V_0,\ j \in V_0 \\
		\Expr*{\ExprCptpReducedCost{i}{j}} + \Expr*{\lambda_1 - \lambda_0} \frac{q_i + q_j}{2} + \beta_j, & \texttt{if } i = 0,\ j \in V_0     \\
		\Expr*{\ExprCptpReducedCost{i}{j}} + \Expr*{\lambda_1 - \lambda_0} \frac{q_i + q_j}{2} + \beta_i, & \texttt{if } i \in V_0,\ j = N
	\end{cases}
\end{equation}

and $\lambda_0 \ge 0, \lambda_1 \ge 0, \beta_i \ge 0 \quad \forall i \in V_0$ are the respective Lagrange multipliers.
The above IP describes an elementary shortest path problem, where the associated weights may be negative.

\cite{beasley1989algorithm} propose a subgradient procedure to obtain feasible lower bound for the original CPTP problem.
Since the ESPP problem with arbitrary weights is an NP-hard problem, they suggest to use a standard Dijkstra algorithm, but in order to do so, the lagrange multipliers must be set such that $c'_{ij} \ge 0$ is satisfied.
By considering only lagrange multipliers achieving $c'_{ij} \ge 0$ has the additional benefit that neglecting the SEC were justified since these would be automatically satisfied.
The advantage of this approach is that it allows for the usage of simple of the shelf algorithms to obtain lower bounds for the CPTP.
But, unfortunately, the lower bounds generated by such approach are unsatisfactory at best.
As pointed out in \cite{righini2004dynamic}, solving the ESPPRC problem through Lagrangean relaxation is effective only when the Lagrangean subproblem is easy, i.e. for which $c'_{ij} \ge 0$ over a good portion of the lagrange multipliers search space.


\section{Additional Valid Inequalities}\label{sec:additional-valid-inequalities}

In this section we present additional valid inequalities for the CPTP problem.
These inequalities are not strictly required to solve a CPTP, but when embedded inside a Branch and Cut framework can heavily speed up the resolution process.
Most of these cuts follow the presentation proposed in \cite{Jepsen2014}.
We will concentrate mostly on the most important ones, additional inequalities and information are treated in more detail in \cite{Jepsen2014}.

\subsection{Generalized Large Multistar (GLM) inequalities}
The Generalized Large Multistar inequalities, GLM for short, were first proposed in \cite{gouveia_result_1995}, and further discussed in \cite{letchford2006projection}.
In the additional work of \cite{letchford_multistars_2002}, the GLM cuts are further generalized in the so-called Knapsack Large Multistar (KLM) inequalities.
The GLM inequalities can be expressed as:

\begin{equation}\label{eq:glm-inequality-v1}
	\begin{split}
		\ExprCptpFlowExiting{S} \ge \frac{2}{Q} \Expr*{  \ExprCptpDemandSumWithin[i]{S} + \ExprCptpDemandServedOutsideA{S} } \quad \forall S \subseteq V_0,\ \SetSize*{S} \ge 2
	\end{split}
\end{equation}

It is important to recall that we defined $q_0 = 0$.
Therefore, $\sum_{i \in S} \sum_{j \in V_0 \setminus S} q_j  x_{ij}$ becomes


\begin{equation}
	\ExprCptpDemandServedOutsideA{S} = \ExprCptpDemandServedOutsideB{S} =\ExprCptpDemandServedOutside{S}
\end{equation}

Finally, equation \eqref{eq:glm-inequality-v1} can be rewritten more concisely as:

\begin{equation}\label{eq:glm-inequality}
	\begin{split}
		\ExprCptpFlowExitingWithWeight{S}{\Expr*{1 - 2 \frac{q_j}{Q}}} - 2 	\ExprCptpServedDemandWithWeight{S}{i}{\frac{q_i}{Q}}  \ge  0   \quad \forall S \subseteq V_0,\ \SetSize*{S} \ge 2
	\end{split}
\end{equation}


Let $\NNZGLM(S)$ denote the number of non-zero binary variables participating in a GLM inequality as a function of the set $S$.
By using equation \eqref{eq:glm-inequality} and the result obtained in \eqref{eq:delta-s-set-size}, we have

\begin{equation}
	\NNZGLM(S) = -\SetSize*{S}^2 + (N + 1)\SetSize*{S}
\end{equation}

which is maximized when $\SetSize*{S} = \frac{N+1}{2}$.
It is now easy to see that the following result holds
\begin{equation}\label{eq:glm-nnz-ub}
	\NNZGLM(S) \le \floor*{ \frac{\Expr*{N + 1}^2}{4}} \quad \forall S \subseteq V_0,\ \SetSize*{S} \ge 2
\end{equation}


\subsection{Rounded Capacity Inequalities (RCI)}
The Rounded Capacity Inequalities, RCI for short, were first presented in \cite{achuthan_capacitated_1998}.

Let $q(S) = \sum_{i \in S} q_i$ and $\ExprQrS = \fmod{q(S)}{Q}$ be respectively the total demand and remainder capacity associated to set $S \subseteq V_0$.
The RCI inequalities can then be expressed as:

\begin{equation}\label{eq:rci-inequality}
	\begin{split}
		\ExprCptpFlowExiting{S} -2 \ExprCptpServedDemandWithWeight{S}{i}{\frac{q_i}{\ExprQrS}}   \ge   2 \left( \ceil*{ \frac{q(S)}{Q}} - \frac{q(S)}{\ExprQrS} \right) \quad \forall S \subseteq V_0
	\end{split}
\end{equation}

Let $\NNZGLM(S)$ denote the number of non-zero binary variables participating in a RCI inequality as a function of the set $S$.
The upper bound on $\NNZ_{\mt{RCI}}(S)$ follows the same reasoning of equation \eqref{eq:glm-nnz-ub}:

\begin{equation}\label{eq:rc-nnz-ub}
	\NNZRCI(S) \le \floor*{\frac{\left( N + 1\right)^2}{4}} \quad \forall S \subseteq V_0
\end{equation}
